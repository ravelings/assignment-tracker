<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <title>Document</title>

    <!-- Bootstrap CSS (v4.3.1) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
  </head>

<title> Dashboard </title>

<body>

    <h1>Dashboard</h1>

        <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Sort by
        </button>
        
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <a class="dropdown-item" href="?sort=due">Due</a>
            <a class="dropdown-item" href="?sort=course">Course</a>
            <a class="dropdown-item" href="?sort=points">Points</a>
        </div>
    </div>

    {% for assignment in assignments %} 
        <h1>Assignment: {{assignment.title}}</h1>
        <p>Assignment ID: {{assignment.assignment_id}} </p>
        <p>Course: {{assignment.course.course_name}}</p>
        <p>Description: {{assignment.description}}</p>
        <p>Due: {{assignment.due}}</p>
        <p>Possible Points: {{assignment.points}}</p>
        <p>Status: {{assignment.status}}</p>
        <div>
            <button 
                id="deleteButton"
                onclick=confirmDialog() 
                type="button" 
                class="btn btn-danger"
                data-assignment-id="{{ assignment.assignment_id }}">
                Delete
            </button>
        </div>>
    {% endfor %}

    <div>
        <button 
            type="button" 
            class="btn btn-primary"
            id="sync"
            onclick=sync()>
            Sync Now
        </button>
    </div>

    <p id="alert"></p>

    <dialog id="confirmDialog">
        <p>Are you sure you want to delete the assignment?</p>
        <div>
            <form id="deleteForm" method="POST">
                {{ deleteForm.submit }}
            </form>
        </div>
        <div>
            <button id="closeDialog" onclick=closeDialog(this)>Cancel</button>
        </div>
    </dialog>

    <dialog id="deleteDialog">
        <p id="deleteMessage"></p>
        <div>
            <button id="closeDialog" onclick=closeDialog(this)>Confirm</button>
        </div>
    </dialog>
    <!-- Bootstrap JS dependencies -->
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
</body>

<script>
    
    function confirmDialog(){
        const confirmDialog = document.getElementById("confirmDialog");

        const button = document.getElementById("deleteButton");
        const assignment_id = button.dataset.assignmentId;

        const form = document.getElementById("deleteForm");
        form.action = `/dashboard/assignments/delete/${assignment_id}`;

        confirmDialog.showModal();
    }
    function closeDialog(){
        const cloesDialog = document.getElementById(this.closest("dialog"));
        closeDialog.close();
    }
    function deleteDialog(message){
        const deleteDialog = document.getElementById("deleteDialog");
        const text = document.getElementById("deleteMessage");
        text.textContent = message;
        deleteDialog.showModal();
    }

    function syncFail(){
        const host = document.getElementById("alert")
        host.innerHTML = `
        <div class="alert alert-danger" role="alert">
            Sync failed!
        </div>
        `;
    }

    function syncSuccess(){
        const host = document.getElementById("alert")
        host.innerHTML = `
        <div class="alert alert-success" role="alert">
            Sync success! Refreshing page...
        </div>
        `;
    }

    async function sync(){
        console.log("Sync starts")
        const button = document.getElementById("sync");
        button.disabled = true;
        try{
            const result = await fetch("/dashboard/assignments/sync", {
            method: "POST",
            headers:{"Content-Type": "application/json"}
            });

            const contentType = result.headers.get("Content-Type") || "";
            if (!contentType.includes("application/json")){
                alert("Login session invalid, please login again");
                return;
            }

            const data = await result.json();

            if (!result.ok || data.status !== "success"){
                syncFail()
                return;
            }
            
            syncSuccess();

            setTimeout(() => location.reload(), 2000);
        }
        finally{
            button.disabled = false;
        }
    }
</script>

{%with messages = get_flashed_messages(with_categories=true)%}
    {%if messages%}
        {% for category, msg in messages %}
            {% if category == "deleteTrue" %}
                <script>
                    deleteDialog({{ msg|tojson }});
                </script>
            {%endif%}
            {% if category == "token" %}
                <script>
                    deleteDialog({{ msg|tojson }});
                </script>
            {%endif%}
        {%endfor%}
    {%endif%}
{%endwith%}
</html>