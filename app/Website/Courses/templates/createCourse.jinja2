<html>
<title>Course Manager</title>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <title>Document</title>

    <!-- Bootstrap CSS (v4.3.1) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" />
</head>

<body>
    <h1>Create Course</h1>
    <div>
        <form method="POST" action="">
            {{ form.hidden_tag() }}
            <p>Course Name: {{form.course_name}} </p>
            <p>Weight: {{form.weight}} </p>
            <p>{{form.submit}}</p>
        </form>
    </div>
    <div>
        <button type="button" class="btn btn-primary" id="sync" onclick=sync()>
            Sync Now
        </button>
    </div>
    <div id="alert"></div>
    <div>
        <dialog id="dialog">
            <p id="message"></p>
            <button onclick=closeDialog()>Confirm</button>
    </div>
    </dialog>
    <!-- Bootstrap JS dependencies -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
</body>

<script>
    const dialog = document.getElementById("dialog");

    function showDialog(message) {
        const text = document.getElementById("message");
        text.textContent = message;
        dialog.showModal();
    }
    function closeDialog() {
        dialog.close();
    }

    function syncFail() {
        const host = document.getElementById("alert")
        host.innerHTML = `
        <div class="alert alert-danger" role="alert">
            Sync failed!
        </div>
        `;
    }

    function syncSuccess() {
        const host = document.getElementById("alert")
        host.innerHTML = `
        <div class="alert alert-success" role="alert">
            Sync success! Refreshing page...
        </div>
        `;
    }

    async function sync() {
        console.log("Sync starts")
        const button = document.getElementById("sync");
        button.disabled = true;
        try {
            const result = await fetch("/createCourse/sync", {
                method: "POST",
                headers: { "Content-Type": "application/json" }
            });

            const contentType = result.headers.get("Content-Type") || "";
            if (!contentType.includes("application/json")) {
                alert("Login session invalid, please login again");
                return;
            }

            const data = await result.json();

            if (!result.ok || data.status !== "success") {
                syncFail()
                return;
            }

            syncSuccess();

            setTimeout(() => location.reload(), 2000);
        }
        finally {
            button.disabled = false;
        }
    }
</script>
{%with messages = get_flashed_messages(with_categories=true)%}
{%if messages%}
{% for category, msg in messages %}
{% if category == "fail" %}
<script>
    showDialog({{ msg| tojson}})
</script>
{%endif%}
{%endfor%}
{%endif%}
{%endwith%}

</html>